// server/api/hello.ts

import * as mysql from "mysql2/promise";

export default defineEventHandler(async event => {
  const body = await readBody(event);
  console.log("body: ", body);
  const id = body.id;
  const ip_source = body.ip_source;
  const ip_dest = body.ip_dest;
  const protocollo = body.protocollo;
  const porta = body.porta;
  const id_azienda = body.id_azienda;
  const data = new Date();

  const stato = 0;

  try {
    // Crea la connessione al database
    const connection = await mysql.createConnection(
      'mysql://c5lv9jv7jcocax04gncj:pscale_pw_zr6YE9l2OQpSSM6XXSz8yXSJht6rEbSO4toNsRMBQup@aws.connect.psdb.cloud/guardianflow?ssl={"rejectUnauthorized":true}'
    );

    await connection.execute(
      "INSERT INTO anomalia (id,ip_sorgente,ip_destinazione,protocollo,porta,id_azienda,data,stato) VALUES (?, ?, ?, ?, ?, ?, ?, ?)",
      [id, ip_source, ip_dest, protocollo, porta, id_azienda, data, stato]
    );

    // Chiudi la connessione dopo aver eseguito le operazioni necessarie
    await connection.end();

    return {
      message: "Vulnerability added!",
    };
  } catch (error: any) {
    console.error("Error connecting to the database:", error);
    return {
      error: error.code,
    };
  }
});
