// server/api/hello.ts
import { Resend } from "resend";

import * as mysql from "mysql2/promise";

export default defineEventHandler(async event => {
  const resend = new Resend("re_GMGHNNfW_7yEcQE5PdPH3rip1Bu1Um8az");

  const body = await readBody(event);
  console.log("body: ", body);
  const id = body.id;
  const ip_source = body.ip_source;
  const ip_dest = body.ip_dest;
  const protocollo = body.protocollo;
  const porta = body.porta;
  const id_azienda = body.id_azienda;
  const data = new Date();

  const stato = 0;

  try {
    // Crea la connessione al database
    const connection = await mysql.createConnection(
      'mysql://c5lv9jv7jcocax04gncj:pscale_pw_zr6YE9l2OQpSSM6XXSz8yXSJht6rEbSO4toNsRMBQup@aws.connect.psdb.cloud/guardianflow?ssl={"rejectUnauthorized":true}'
    );

    await connection.execute(
      "INSERT INTO anomalia (id,ip_sorgente,ip_destinazione,protocollo,porta,id_azienda,data,stato) VALUES (?, ?, ?, ?, ?, ?, ?, ?)",
      [id, ip_source, ip_dest, protocollo, porta, id_azienda, data, stato]
    );
    (async function () {
      const { data, error } = await resend.emails.send({
        from: "Guardian Flow <onboarding@resend.dev>",
        to: ["gremsrls@gmail.com"],
        subject: "[MASSIMA ATTENZIONE] Nuova vulnerabilità rilevata!",
        html:
          "Nuova possibile vulnerabilità rilevata " +
          "<br> <b>Id: </b>" +
          id +
          "<br> <b>Ip sorgente: </b>" +
          ip_source +
          "<br> <b>Ip destinazione: </b>" +
          ip_dest +
          "<br> <b>Protocollo: </b>" +
          protocollo +
          "<br> <b>Porta: </b>" +
          porta +
          " <br> <a href='http://localhost:3000/gestionale/dashboard'>Clicca qui per accedere</a>",
      });

      if (error) {
        return console.error({ error });
      }

      console.log({ data });
    })();

    // Chiudi la connessione dopo aver eseguito le operazioni necessarie
    await connection.end();

    return {
      message: "Vulnerability added!",
    };
  } catch (error: any) {
    console.error("Error connecting to the database:", error);
    return {
      error: error.code,
    };
  }
});
